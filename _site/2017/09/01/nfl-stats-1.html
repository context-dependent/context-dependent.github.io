<!DOCTYPE html>
<html>
    <!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/logo.png">
    <link rel="icon" type="image/png" href="/assets/images/pos_points.png">

    <title>HTML TABLES</title>

    <meta name="keywords" content="thomas mcmanus, context-dependent, R">
    <meta name="author" content="context-dependent">
    <meta name="description" content="This is a bad blog. Don't read thi blog
">

    <meta property="og:site_name" content="context-dependent">
    <meta property="og:url" content="/">
    <meta property="og:title" content="HTML TABLES">
    <meta property="og:type" content="article">
    <meta property="og:description" content="This series will use historical data from NFL seasons between 1992 and 2016 to illustrate some data munging, analysis, and visualization techniques in R. Ame...">

    <!--   Core CSS Files   -->
    <link href="//cdn.bootcss.com/flex-layout-attribute/1.0.3/css/flex-layout-attribute.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

    <!-- Canonical SEO -->
    <link rel="canonical" href="http://localhost:4000/2017/09/01/nfl-stats-1.html">
    <link rel="alternate" type="application/rss+xml" title="context dependent" href="http://localhost:4000/feed.xml">
</head>

<body>
    <div id="nav" layout="row top-left">
    <div self="left">
        <a href="/"><div class="logo logo-isNotVisIfMobile">context dependent</div></a>
        <a href="/"><div class="logo logo-isVisIfMobile"></div></a>
    </div>
    <div class="nav-isNotVisIfMobile">
        <div class="item">
            <a href="/tags">Tags</a>
        </div>
        <div class="item">
            <a href="/videos">Videos</a>
        </div>
    </div>
    <div class="nav-isVisIfMobile">
        <div class="item">
            <a href="/tags">Tags</a>
        </div>
        <div class="item">
            <a href="/videos">Videos</a>
        </div>
    </div>
</div>

    <div id="content">
        <div class="container container--header">
    <h1 class="h1--home-title">HTML TABLES</h1>
    <p>Scrape historical NFL data from Pro-Football-Reference.com using rvest and dplyr.</p>
</div>

        <link rel="stylesheet" type="text/css" href="/assets/css/article.css">

<div class="page-wrapper">
    <div class="container--text">
        <p>This series will use historical data from NFL seasons between 1992 and 2016 to illustrate some data munging, analysis, and visualization techniques in R. American football is particularly suited to analysis because of its stop / reset / start structure, the singular focus of every play (one pass, one run, one kick etc.), and the strictly defined, narrow roles played by each man on the field.</p>

<p>Pro-Football-Reference has a wealth of freely available detailed historical data. We are going to use <code class="highlighter-rouge">rvest</code> and <code class="highlighter-rouge">dplyr</code>, part of the <code class="highlighter-rouge">tidyverse</code>, to scrape, clean, and concatenate that historical data.</p>

<h2 id="scraping-functions">Scraping functions</h2>

<p>For each table on their site, PFR offers the option of saving the data as a <code class="highlighter-rouge">.csv</code> file. While this would be congenial if we wanted to look at one or two years of data, doing it 24 times would be tedious and, for me at least, prone to errors. The <code class="highlighter-rouge">rvest</code> package makes scraping the tables automatically virtually painless. With the added benefit that the data can be reloaded from scratch in the event of a mistake, the benefits of building the <code class="highlighter-rouge">scrape_fantasy</code> function far outweigh the costs.</p>

<h3 id="get-one-table-from-pfr">Get one table from PFR</h3>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="cd">#' Scrape and clean data from profootballreference.com for a single
#' returns a single tibble with a position, passing, rushing, receiving
#' statistics for each player, along with age etc.
#'
#' @param yr integer -- integers between 1992 and 2016
#'
#' @return tbl_clean a tibble
#' @export
#'
#' @examples
#'
</span><span class="n">pfr_single</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"https://www.pro-football-reference.com/years/%d/fantasy.htm"</span><span class="p">,</span><span class="w">
                 </span><span class="n">yr</span><span class="p">)</span><span class="w">

  </span><span class="n">cols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"rank"</span><span class="p">,</span><span class="w"> </span><span class="s2">"name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"team"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pos"</span><span class="p">,</span><span class="w"> </span><span class="s2">"age"</span><span class="p">,</span><span class="w"> </span><span class="s2">"played"</span><span class="p">,</span><span class="w"> </span><span class="s2">"started"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"pass_cmp"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pass_att"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pass_yds"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pass_td"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pass_int"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"rush_att"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rush_yds"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rush_ypc"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rush_td"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"rec_tgt"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rec_rec"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rec_yds"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rec_ypr"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rec_td"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"f_points"</span><span class="p">,</span><span class="w"> </span><span class="s2">"dkpt"</span><span class="p">,</span><span class="w"> </span><span class="s2">"fdpt"</span><span class="p">,</span><span class="w"> </span><span class="s2">"vbd"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pos_rank"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ov_rank"</span><span class="p">)</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w">
  </span><span class="n">tbl_raw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">read_html</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                </span><span class="n">html_table</span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">))[[</span><span class="m">1</span><span class="p">]]</span><span class="w">

  </span><span class="n">colnames</span><span class="p">(</span><span class="n">tbl_raw</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cols</span><span class="w">

  </span><span class="n">tbl_clean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tbl_raw</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yr</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">filter</span><span class="p">(</span><span class="n">complete.cases</span><span class="p">(</span><span class="n">.</span><span class="p">))</span><span class="w">

  </span><span class="nf">return</span><span class="p">(</span><span class="n">tbl_clean</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h3 id="apply-pfr_single-to-a-to-a-range-of-years">Apply pfr_single to a to a range of years</h3>

<p><code class="highlighter-rouge">scrape_fantasy</code> applies (using <code class="highlighter-rouge">lapply</code>) the pfr_single function to a vector of years, which returns a list of data frames that are bound together using <code class="highlighter-rouge">dplyr::bind_rows</code>. Before returning the bound data, we use <code class="highlighter-rouge">dplyr::mutate_at</code> to type all of the numeric columns, and then filter out players that have no fantasy points recorded in a season.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="cd">#' Scrape and clean data from profootballreference.com for a range of years.
#' returns a single tibble with a position, passing, rushing, receiving
#' statistics for each player, along with age etc.
#'
#' @param yrs vector -- integers between 1993 and 2016
#' @param write logical -- whether or not to write the cleaned data to a csv in
#' the ./Data folder
#'
#' @return df_bound a tibble
#' @export fantasy_data_YRSTART_YREND.csv
#'
#' @examples
#'
</span><span class="n">scrape_fantasy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">yrs</span><span class="p">,</span><span class="w"> </span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="w">
    </span><span class="n">df_bound</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">yrs</span><span class="p">,</span><span class="w"> </span><span class="n">pfr_single</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">bind_rows</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">as_data_frame</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">mutate_at</span><span class="p">(</span><span class="w">
        </span><span class="n">.vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vars</span><span class="p">(</span><span class="o">-</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">team</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">pos</span><span class="p">),</span><span class="w">
        </span><span class="n">.funs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.numeric</span><span class="w">
      </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
      </span><span class="n">filter</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">f_points</span><span class="p">))</span><span class="w">
  </span><span class="p">)</span><span class="w">

  </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">write_csv</span><span class="p">(</span><span class="n">df_bound</span><span class="p">,</span><span class="w">
      </span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"./Data/fantasy_data_%d_%d.csv"</span><span class="p">,</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">yrs</span><span class="p">),</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">yrs</span><span class="p">)))</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">df_bound</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h2 id="example-plots">Example plots</h2>

<p>We use the <code class="highlighter-rouge">scrape_fantasy</code> function defined above to collect season totals for each offensive player for the seasons between 1992 and 2016.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">df_stats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">scrape_fantasy</span><span class="p">(</span><span class="n">yrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1992</span><span class="o">:</span><span class="m">2016</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>Now that the data are all together, cleaned, and correctly typed, <code class="highlighter-rouge">ggplot2</code> offers a set of tools for quickly making exploratory visualizations. The following plots are not particularly refined, but they are a pretty good representation of the kind of thing that I would do when approaching any new data set “in the wild”, so to speak.</p>

<h3 id="total-point-distributions-by-position">Total point distributions by position</h3>

<p>The facetted histogram (or density plot) is a favourite tool of mine for identifying differences among groups.</p>

<p>code</p>
<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">df_stats</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">f_points</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">f_points</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggthemes</span><span class="o">::</span><span class="n">scale_fill_wsj</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">pos</span><span class="o">~</span><span class="n">.</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p>plot
<img src="http://localhost:4000/assets/images/pos_points.png" alt="season points by position plot" /></p>

<h3 id="total-point-concentrations-by-age-with-player-count-bars">Total point concentrations by age (with player count bars)</h3>

<p>Jitter plots are imprecise by nature, but I like them when trying to get a sense of a continuous variable’s distribution as a function of a discrete variable, where a regular scatter plot would be unclear because many points would be stacked up on one another. I favour them over violin plots and boxplots because I find that those can obfuscate potentially interesting facts of the distributions in question.</p>

<p>This plot also includes bars behind the jittered points that indicate the number of players that have played a season between 1992 and 2016 at the given age and position. Therefore the y-axis of each facet represents both fantasy points and number of players at the position.</p>

<p>code</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">df_stats</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">f_points</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">age</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_jitter</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f_points</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
  </span><span class="n">ggthemes</span><span class="o">::</span><span class="n">scale_color_wsj</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">pos</span><span class="o">~</span><span class="n">.</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>plot</p>

<p><img src="http://localhost:4000/assets/images/age_points.png" alt="season points by age" /></p>

    </div>
</div>

<style type="text/css">
    .ds-thread {
        max-width: 680px;
        margin: auto;
    }
</style>

<!-- 多说评论框 start -->
<!-- <div class="ds-thread" data-thread-key="/2017/09/01/nfl-stats-1.html" data-title=HTML TABLES data-url=http://localhost:4000/2017/09/01/nfl-stats-1.html></div> -->
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
// var duoshuoQuery = {short_name:"wnglmng"};
//     (function() {
//         var ds = document.createElement('script');
//         ds.type = 'text/javascript';ds.async = true;
//         ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
//         ds.charset = 'UTF-8';
//         (document.getElementsByTagName('head')[0]
//          || document.getElementsByTagName('body')[0]).appendChild(ds);
//     })();
</script>
<!-- 多说公共JS代码 end -->

<div class="related_posts-container" style="max-width: 790px;">
    <p class="related_posts-header">RELATED ARTICLES</p>

    <div layout="rows center-spread">

        

        
        
        
        
            <a href="/2017/09/03/r-stacked-bar.html">
                <div class="card card--article not-visible" >
                    <div class="card-body">
                        <div class="card-title">STACKED BARS</div>
                        <div class="card-description card-description--clamp-0">
                            ## Import PackagesInstall these packages if you don't have them already```rlibrary(tidyverse)library(ggthemes)```## Make fake game dataThis is a streamlined version of the structure we talked about...
                        </div>
                    </div>
                    <div class="card-hero">
                        <div class="card-image card-image--size-185" data-url="https://context-dependent.github.io/assets/images/stacked_bar.png"></div>
                    </div>
                    <div class="card-footer">
                        <div class="card-footer-wrapper" layout="row bottom-left">
                            <div class="card-type is-notShownIfHover">2017-09-03</div>
                            <div class="card-tag is-notShownIfHover">@</div>
                            <div class="card-tag is-shownIfHover">
                                
                                    code &nbsp;&nbsp;
                                
                                    R &nbsp;&nbsp;
                                
                                    ggplot2 &nbsp;&nbsp;
                                
                                    tidyverse &nbsp;&nbsp;
                                
                            </div>
                            <div class="card-logo is-shownIfHover" self="right"></div>
                        </div>
                    </div>
                 </div>
            </a>
        
        

    </div>
</div>


    </div>
    <div id="footer" layout="rows center-left">
    <div id="end-mark">
        <div class="end-mark-icon"></div>
        <p class="copyright">context-dependent © 2017</p>
    </div>
    <div id="footer-links" self="right">
        <ul>
            <a href="#"><li class="wechat" target="_blank"></li></a>
            <a href="mailto:" target="_blank"><li class="mail"></li></a>
            <a href="http://weibo.com/" target="_blank"><li class="weibo"></li></a>
            <a href="https://github.com/" target="_blank"><li class="github"></li></a>
        </ul>
    </div>
</div>

</body>
<!--   Core JS Files   -->
<script src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script src="//cdn.bootcss.com/mixitup/2.1.11/jquery.mixitup.min.js"></script>
<script src="/assets/js/main.js"></script>

</html>
