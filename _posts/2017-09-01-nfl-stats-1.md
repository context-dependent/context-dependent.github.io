---
layout:         post
title:          NFL stats 1
subtitle:       Scraping and cleaning data from Pro-Football-Reference.com
card-image:     
date:           2017-09-01 14:14:00
tags:           code
post-card-type: article
---

This series will use historical data from NFL seasons between 1992 and 2016 to illustrate some data munging, analysis, and visualization techniques in R. American football is particularly suited to analysis because of its stop / reset / start structure, the singular focus of every play (one pass, one run, one kick etc.), and the strictly defined, narrow roles played by each man on the field.

Pro-Football-Reference has a wealth of freely available detailed historical data. We are going to use `rvest` and `dplyr`, part of the `tidyverse`, to scrape, clean, and concatenate that historical data.

##Scraping functions

###Get one table from PFR
```{r}
pfr_single <- function(yr) {
  url <- sprintf("https://www.pro-football-reference.com/years/%d/fantasy.htm",
                 yr)

  cols <- c("rank", "name", "team", "pos", "age", "played", "started",
            "pass_cmp", "pass_att", "pass_yds", "pass_td", "pass_int",
            "rush_att", "rush_yds", "rush_ypc", "rush_td",
            "rec_tgt", "rec_rec", "rec_yds", "rec_ypr", "rec_td",
            "f_points", "dkpt", "fdpt", "vbd", "pos_rank", "ov_rank")
  print(url)
  tbl_raw <- (read_html(url) %>%
                html_table(header = FALSE))[[1]]

  colnames(tbl_raw) <- cols

  tbl_clean <- tbl_raw %>%
    mutate(year = yr, rank = as.integer(rank)) %>%
    filter(complete.cases(.))

  return(tbl_clean)
}
```
###Apply pfr_single to a to a range of years
```{r}
#' Scrape and clean data from profootballreference.com for a range of years.
#' returns a single tibble with a position, passing, rushing, receiving
#' statistics for each player, along with age etc.
#'
#' @param yrs vector -- integers between 1993 and 2016
#' @param write logical -- whether or not to write the cleaned data to a csv in
#' the ./Data folder
#'
#' @return df_bound a tibble
#' @export fantasy_data_YRSTART_YREND.csv
#'
#' @examples
#'
scrape_fantasy <- function(yrs, write = TRUE) {
  suppressWarnings(
    df_bound <- lapply(yrs, pfr_single) %>% bind_rows %>%
      as_data_frame() %>%
      mutate_at(
        .vars = vars(-name, -team, -pos),
        .funs = as.numeric
      ) %>%
      filter(pos != "", !is.na(f_points))
  )

  if(write) {
    write_csv(df_bound,
      sprintf("./Data/fantasy_data_%d_%d.csv", min(yrs), max(yrs)))
  }
  return(df_bound)
}
```

##Example plots

###Season point distributions by position
```{r}
df_stats %>%
  filter(f_points > 0) %>%
  ggplot(aes(f_points, fill = pos)) +
  geom_histogram(binwidth = 1) +
  ggthemes::scale_fill_wsj() +
  facet_grid(pos~.)
```
![season points by position plot]({{ site.url }}/assets/images/pos_points.png)
